version: '3.9'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: ${WEB_PORT:-3000}
      API_PORT: ${API_PORT:-4000}
      DATABASE_URL: ${DATABASE_URL:-postgresql://possible:possible@postgres:5432/possible}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:${API_PORT:-4000}}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-me}
      HCAPTCHA_SECRET: ${HCAPTCHA_SECRET:-0x0000000000000000000000000000000000000000}
      NEXT_PUBLIC_HCAPTCHA_SITE_KEY: ${NEXT_PUBLIC_HCAPTCHA_SITE_KEY:-10000000-ffff-ffff-ffff-000000000001}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      OBJECT_STORAGE_BUCKET: ${OBJECT_STORAGE_BUCKET:-tackle-uploads}
      OBJECT_STORAGE_REGION: ${OBJECT_STORAGE_REGION:-us-east-1}
      OBJECT_STORAGE_ENDPOINT: ${OBJECT_STORAGE_ENDPOINT:-http://minio:9000}
      OBJECT_STORAGE_PUBLIC_URL: ${OBJECT_STORAGE_PUBLIC_URL:-http://localhost:9000}
      OBJECT_STORAGE_ACCESS_KEY: ${OBJECT_STORAGE_ACCESS_KEY:-minioadmin}
      OBJECT_STORAGE_SECRET_KEY: ${OBJECT_STORAGE_SECRET_KEY:-minioadmin}
      SMTP_HOST: ${SMTP_HOST:-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
    ports:
      - '3000:3000'

  postgres:
    image: postgres:15
    profiles: ['postgres']
    environment:
      POSTGRES_USER: possible
      POSTGRES_PASSWORD: possible
      POSTGRES_DB: possible
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'possible']
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - '5432:5432'

  redis:
    image: redis:7-alpine
    profiles: ['redis']
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - '6379:6379'

  minio:
    image: minio/minio:RELEASE.2024-04-18T19-09-19Z
    profiles: ['minio']
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    ports:
      - '9000:9000'
      - '9001:9001'

  mailhog:
    image: mailhog/mailhog:v1.0.1
    profiles: ['mailhog']
    ports:
      - '1025:1025'
      - '8025:8025'

volumes:
  postgres-data:
  redis-data:
  minio-data:
