generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["extendedWhereUnique"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SUPPORT
  SELLER
  BUYER
}

enum AddressType {
  SHIPPING
  BILLING
  OTHER
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PAUSED
  SOLD
  ARCHIVED
}

enum TackleCondition {
  NEW_IN_BOX
  LIKE_NEW
  EXCELLENT
  GOOD
  FAIR
  ROUGH_WATER_TESTED
}

enum TackleCategory {
  ROD
  REEL
  ROD_AND_REEL_COMBO
  LURE
  LINE
  TERMINAL_TACKLE
  ELECTRONICS
  APPAREL
  STORAGE_AND_ORGANIZATION
  BOAT_AND_MARINE_ACCESSORY
}

enum WaterType {
  FRESHWATER
  SALTWATER
  BRACKISH
}

enum OfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  COUNTERED
  WITHDRAWN
  EXPIRED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  FULFILLED
  CANCELLED
  REFUNDED
  DISPUTED
}

enum OrderEventType {
  CREATED
  PAYMENT_CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  DISPUTE_OPENED
  DISPUTE_RESOLVED
  NOTE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CHARGEBACK
}

enum PayoutStatus {
  PENDING
  RELEASED
  FAILED
}

enum ShipmentStatus {
  PREPARING
  SHIPPED
  DELIVERED
  RETURNED
  LOST
}

enum ShipmentTrackingStatus {
  UNKNOWN
  LABEL_PURCHASED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  EXCEPTION
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  ESCALATED
  RESOLVED
  CLOSED
}

enum NotificationType {
  OFFER_RECEIVED
  OFFER_UPDATED
  ORDER_UPDATED
  DISPUTE_UPDATED
  SYSTEM
}

enum HelpArticleStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum ThreadType {
  ORDER
  LISTING
  SUPPORT
  COMMUNITY
}

enum MessageType {
  STANDARD
  SYSTEM
  MODERATION
}

enum ModerationEventType {
  MESSAGE
  REVIEW
}

enum ReviewStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  BLOCKED
}

model User {
  id               String             @id @default(uuid())
  email            String             @unique
  passwordHash     String
  displayName      String
  bio              String?
  role             UserRole           @default(BUYER)
  phoneNumber      String?
  avatarUrl        String?
  emailVerified    DateTime?
  dateOfBirth      DateTime?
  ageVerifiedAt    DateTime?
  policyAcceptances PolicyAcceptance[]
  marketingOptIn   Boolean            @default(false)
  twoFactorEnabled Boolean            @default(false)
  twoFactorSecret  String?
  stripeCustomerId String?            @unique
  stripeConnectId  String?            @unique
  lastLoginAt      DateTime?
  listings         Listing[]          @relation("ListingSeller")
  offers           Offer[]            @relation("OfferBuyer")
  ordersBought     Order[]            @relation("OrderBuyer")
  ordersSold       Order[]            @relation("OrderSeller")
  disputesRaised   Dispute[]          @relation("DisputeRaisedBy")
  disputesAssigned Dispute[]          @relation("DisputeAssignedTo")
  disputeMessages  DisputeMessage[]
  addresses        Address[]
  notifications    Notification[]
  accounts         Account[]
  sessions         Session[]
  totpDevices      TotpDevice[]
  carts            Cart[]
  payouts          Payout[]          @relation("SellerPayouts")
  auditLogs        AuditLog[]        @relation("UserAuditLogs")
  orderMessages            OrderMessage[]
  reviewsAuthored          Review[]                    @relation("AuthorReviews")
  reviewsReceived          Review[]                    @relation("TargetReviews")
  moderationEvents         ModerationEvent[]
  notificationSettings     NotificationSetting[]       @relation("UserNotificationSettings")
  reviewModerationDecisions ReviewModerationDecision[] @relation("UserReviewModerations")
  shippingProfiles          ShippingProfile[]
  threadsCreated            Thread[]                   @relation("ThreadsCreated")
  threadMemberships         ThreadParticipant[]
  messages                  Message[]
  helpArticles              HelpArticle[]              @relation("HelpArticleAuthor")
  policiesAuthored          Policy[]                   @relation("PolicyAuthor")
  recommendationCaches      RecommendationCache[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model Account {
  id                 Int      @id @default(autoincrement())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model TotpDevice {
  id          String   @id @default(uuid())
  userId      String
  secret      String
  label       String?
  verifiedAt  DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PolicyAcceptance {
  id             String   @id @default(uuid())
  userId         String
  policyId       String
  policyVersion  String
  acceptedAt     DateTime @default(now())
  ipAddress      String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  policy         Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([userId, policyId, policyVersion], map: "idx_policy_acceptance_user_policy_version")
}

model Policy {
  id                     String              @id @default(uuid())
  slug                   String              @unique
  title                  String
  summary                String?
  body                   String
  category               String
  version                String              @default("1.0.0")
  audience               String?
  isRequiredForSellers   Boolean             @default(false)
  isRequiredForBuyers    Boolean             @default(false)
  isActive               Boolean             @default(false)
  publishedAt            DateTime?
  archivedAt             DateTime?
  authorId               String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  author                 User?               @relation("PolicyAuthor", fields: [authorId], references: [id])
  acceptances            PolicyAcceptance[]
  helpArticles           HelpArticle[]
  listings               Listing[]

  @@index([category], map: "idx_policy_category")
  @@index([isActive], map: "idx_policy_active")
}

model HelpArticle {
  id                 String             @id @default(uuid())
  slug               String             @unique
  title              String
  summary            String?
  content            String
  status             HelpArticleStatus  @default(DRAFT)
  category           String?
  keywords           String[]           @default([])
  audience           String?
  relatedPolicyId    String?
  authorId           String
  featuredImageUrl   String?
  readingTimeMinutes Int?
  publishedAt        DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  author             User              @relation("HelpArticleAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  relatedPolicy      Policy?           @relation(fields: [relatedPolicyId], references: [id])

  @@index([status], map: "idx_help_article_status")
  @@index([category], map: "idx_help_article_category")
}

model Address {
  id          String      @id @default(uuid())
  userId      String
  label       String?
  type        AddressType @default(SHIPPING)
  line1       String
  line2       String?
  city        String
  state       String?
  postalCode  String
  country     String
  isDefault   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingFor Order[]     @relation("OrderShippingAddress")
  billingFor  Order[]     @relation("OrderBillingAddress")
}

model Listing {
  id                     String            @id @default(uuid())
  sellerId               String
  title                  String
  slug                   String            @unique
  description            String
  price                  Decimal           @db.Decimal(10, 2)
  currency               String            @default("USD")
  quantity               Int               @default(1)
  status                 ListingStatus     @default(DRAFT)
  category               String?
  tags                   String[]          @default([])
  brand                  String
  modelName              String?
  condition              TackleCondition   @default(GOOD)
  tackleCategory         TackleCategory?
  waterType              WaterType?
  lureStyle              String?
  targetSpecies          String[]          @default([])
  techniqueTags          String[]          @default([])
  seasonalUse            String[]          @default([])
  lineRatingLbMin        Int?
  lineRatingLbMax        Int?
  rodPower               String?
  rodAction              String?
  gearRatio              String?
  bearingCount           Int?
  maxDragLb              Decimal?          @db.Decimal(6, 2)
  weightOz               Decimal?          @db.Decimal(6, 2)
  lengthIn               Decimal?          @db.Decimal(6, 2)
  customNotes            String?
  autoAcceptOfferCents   Int?
  minimumOfferCents      Int?
  shippingProfileId      String?
  shippingWeightOz       Decimal?          @db.Decimal(8, 2)
  shippingLengthIn       Decimal?          @db.Decimal(8, 2)
  shippingWidthIn        Decimal?          @db.Decimal(8, 2)
  shippingHeightIn       Decimal?          @db.Decimal(8, 2)
  handlingTimeDays       Int?
  featuredPhotoUrl       String?
  compliancePolicyId     String?
  seoKeywords            String[]          @default([])
  publishedAt            DateTime?
  archivedAt             DateTime?
  seller                 User              @relation("ListingSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  compliancePolicy       Policy?           @relation(fields: [compliancePolicyId], references: [id])
  shippingProfile        ShippingProfile?  @relation(fields: [shippingProfileId], references: [id])
  offers                 Offer[]
  orders                 Order[]
  cartItems              CartItem[]
  orderItems             OrderItem[]
  images                 ListingImage[]
  threads                Thread[]
  recommendations        RecommendationCache[]
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  @@index([status], map: "idx_listing_status")
  @@index([sellerId, status], map: "idx_listing_seller_status")
  @@index([brand], map: "idx_listing_brand")
  @@index([tackleCategory], map: "idx_listing_tackle_category")
  @@index([condition], map: "idx_listing_condition")
}

model ListingImage {
  id        String   @id @default(uuid())
  listingId String
  url       String
  altText   String?
  position  Int      @default(0)
  isPrimary Boolean  @default(false)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model ShippingProfile {
  id                   String   @id @default(uuid())
  sellerId             String
  label                String
  courierPreference    String?
  serviceLevel         String?
  shipFromCity         String?
  shipFromState        String?
  shipFromPostalCode   String?
  shipFromCountry      String   @default("US")
  packageType          String?
  packageWeightOz      Decimal? @db.Decimal(8, 2)
  packageLengthIn      Decimal? @db.Decimal(8, 2)
  packageWidthIn       Decimal? @db.Decimal(8, 2)
  packageHeightIn      Decimal? @db.Decimal(8, 2)
  insurancePreferred   Boolean  @default(false)
  insuranceAmountCents Int?
  signatureRequired    Boolean  @default(false)
  handlingNotes        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  seller               User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  listings             Listing[]
  shipments            Shipment[]
  orders               Order[]

  @@index([sellerId], map: "idx_shipping_profile_seller")
  @@index([serviceLevel], map: "idx_shipping_profile_service_level")
}

model Offer {
  id          String      @id @default(uuid())
  listingId   String
  buyerId     String
  amount      Decimal     @db.Decimal(10, 2)
  status      OfferStatus @default(PENDING)
  message     String?
  expiresAt   DateTime?
  respondedAt DateTime?
  counterAmount Decimal?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  listing     Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer       User        @relation("OfferBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  order       Order?       @relation("OfferOrder")
  cartItem    CartItem?    @relation("OfferCartItem")
  orderItems  OrderItem[]  @relation("OfferOrderItems")
}

model Order {
  id                 String              @id @default(uuid())
  listingId          String
  buyerId            String
  sellerId           String
  offerId            String?             @unique
  shippingAddressId  String?
  billingAddressId   String?
  status             OrderStatus         @default(PENDING)
  totalAmount        Decimal             @db.Decimal(12, 2)
  currency           String              @default("USD")
  quantity           Int                 @default(1)
  subtotalAmount     Decimal?            @db.Decimal(12, 2)
  shippingAmount     Decimal?            @db.Decimal(12, 2)
  taxAmount          Decimal?            @db.Decimal(12, 2)
  discountAmount     Decimal?            @db.Decimal(12, 2)
  serviceFeeAmount   Decimal?            @db.Decimal(12, 2)
  insuranceAmount    Decimal?            @db.Decimal(12, 2)
  shippingProfileId  String?
  buyerNote          String?
  sellerNote         String?
  tackleTechnique    String?
  targetSpecies      String[]            @default([])
  preferredDeliveryWindow String?
  isGift             Boolean             @default(false)
  giftMessage        String?
  submittedAt        DateTime?           @default(now())
  fulfilledAt        DateTime?
  cancelledAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  listing            Listing             @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer              User                @relation("OrderBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller             User                @relation("OrderSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  offer              Offer?              @relation("OfferOrder", fields: [offerId], references: [id])
  shippingProfile    ShippingProfile?    @relation(fields: [shippingProfileId], references: [id])
  payment            Payment?
  shipment           Shipment?
  timelineEvents     OrderTimelineEvent[]
  disputes           Dispute[]
  items              OrderItem[]
  paymentIntents     PaymentIntent[]
  payout             Payout?
  shippingAddress    Address?            @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress     Address?            @relation("OrderBillingAddress", fields: [billingAddressId], references: [id])
  messages           OrderMessage[]
  reviews            Review[]
  threads            Thread[]

  @@index([status], map: "idx_order_status")
}

model OrderTimelineEvent {
  id        String          @id @default(uuid())
  orderId   String
  type      OrderEventType
  detail    String
  metadata  Json?
  createdAt DateTime        @default(now())
  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Payment {
  id              String        @id @default(uuid())
  orderId         String        @unique
  status          PaymentStatus @default(PENDING)
  amount          Decimal       @db.Decimal(12, 2)
  provider        String?
  transactionRef  String?
  paidAt          DateTime?
  currency        String?
  applicationFeeAmount Decimal? @db.Decimal(12, 2)
  taxAmount       Decimal?      @db.Decimal(12, 2)
  escrowAmount    Decimal?      @db.Decimal(12, 2)
  stripePaymentIntentId String? @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model PaymentIntent {
  id         String        @id @default(uuid())
  orderId    String
  stripeId   String        @unique
  clientSecret String?
  status     String
  amount     Decimal       @db.Decimal(12, 2)
  currency   String        @default("USD")
  metadata   Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  order      Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Cart {
  id        String     @id @default(uuid())
  buyerId   String
  active    Boolean    @default(true)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  buyer     User       @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, active], map: "idx_cart_buyer_active")
}

model CartItem {
  id         String   @id @default(uuid())
  cartId     String
  listingId  String
  offerId    String?  @unique
  quantity   Int      @default(1)
  unitPrice  Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  offer      Offer?   @relation("OfferCartItem", fields: [offerId], references: [id])

  @@index([cartId], map: "idx_cart_item_cart")
}

model OrderItem {
  id         String   @id @default(uuid())
  orderId    String
  listingId  String
  offerId    String?
  quantity   Int      @default(1)
  unitPrice  Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  offer      Offer?   @relation("OfferOrderItems", fields: [offerId], references: [id])
}

model Payout {
  id          String       @id @default(uuid())
  orderId     String       @unique
  sellerId    String
  amount      Decimal      @db.Decimal(12, 2)
  currency    String       @default("USD")
  status      PayoutStatus @default(PENDING)
  transferId  String?      @unique
  releasedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  seller      User         @relation("SellerPayouts", fields: [sellerId], references: [id], onDelete: Cascade)
}

model Shipment {
  id                     String                  @id @default(uuid())
  orderId                String                  @unique
  status                 ShipmentStatus          @default(PREPARING)
  provider               String?
  carrier                String?
  serviceLevel           String?
  trackingNumber         String?
  trackingUrl            String?
  trackingSubscriptionId String?
  trackingStatus         ShipmentTrackingStatus  @default(UNKNOWN)
  trackingStatusDetail   String?
  trackingLastEventAt    DateTime?
  trackingLastCheckedAt  DateTime?
  trackingNextCheckAt    DateTime?
  labelUrl               String?
  labelKey               String?
  labelCost              Decimal?                @db.Decimal(10, 2)
  labelCurrency          String?
  labelPurchasedAt       DateTime?
  shippedAt              DateTime?
  deliveredAt            DateTime?
  shippingProfileId      String?
  packageWeightOz        Decimal?                @db.Decimal(8, 2)
  packageLengthIn        Decimal?                @db.Decimal(8, 2)
  packageWidthIn         Decimal?                @db.Decimal(8, 2)
  packageHeightIn        Decimal?                @db.Decimal(8, 2)
  requiresSignature      Boolean                 @default(false)
  insuredAmount          Decimal?                @db.Decimal(10, 2)
  pickupScheduledAt      DateTime?
  droppedOffAt           DateTime?
  estimatedDeliveryAt    DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  order                  Order                   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shippingProfile        ShippingProfile?        @relation(fields: [shippingProfileId], references: [id])
}

model Thread {
  id                  String           @id @default(uuid())
  subject             String
  type                ThreadType
  listingId           String?
  orderId             String?
  createdById         String
  lastMessagePreview  String?
  lastMessageAt       DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  listing             Listing?         @relation(fields: [listingId], references: [id], onDelete: SetNull)
  order               Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  createdBy           User             @relation("ThreadsCreated", fields: [createdById], references: [id], onDelete: Cascade)
  participants        ThreadParticipant[]
  messages            Message[]

  @@index([type], map: "idx_thread_type")
  @@index([listingId], map: "idx_thread_listing")
  @@index([orderId], map: "idx_thread_order")
}

model ThreadParticipant {
  id                     String   @id @default(uuid())
  threadId               String
  userId                 String
  role                   String?
  joinedAt               DateTime @default(now())
  lastViewedAt           DateTime?
  notificationsMutedUntil DateTime?
  thread                 Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId], map: "uniq_thread_participant")
  @@index([userId], map: "idx_thread_participant_user")
}

model Message {
  id           String      @id @default(uuid())
  threadId     String
  senderId     String
  type         MessageType @default(STANDARD)
  body         String
  attachments  Json?
  waterBody    String?
  sentAt       DateTime    @default(now())
  readAt       DateTime?
  metadata     Json?
  thread       Thread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender       User        @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([threadId], map: "idx_message_thread")
  @@index([senderId], map: "idx_message_sender")
}

model RecommendationCache {
  id              String   @id @default(uuid())
  listingId       String?
  userId          String?
  context         String
  recommendations Json
  generatedAt     DateTime @default(now())
  expiresAt       DateTime?
  listing         Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([listingId], map: "idx_recommendation_listing")
  @@index([userId], map: "idx_recommendation_user")
  @@index([context], map: "idx_recommendation_context")
}

model Dispute {
  id             String         @id @default(uuid())
  orderId        String         @unique
  raisedById     String
  assignedToId   String?
  status         DisputeStatus  @default(OPEN)
  reason         String
  resolution     String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  resolvedAt     DateTime?
  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  raisedBy       User           @relation("DisputeRaisedBy", fields: [raisedById], references: [id], onDelete: Cascade)
  assignedTo     User?          @relation("DisputeAssignedTo", fields: [assignedToId], references: [id])
  messages       DisputeMessage[]
}

model OrderMessage {
  id        String   @id @default(uuid())
  orderId   String
  authorId  String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([orderId], map: "idx_order_message_order")
  @@index([authorId], map: "idx_order_message_author")
}

model DisputeMessage {
  id         String   @id @default(uuid())
  disputeId  String
  authorId   String
  body       String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  dispute    Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model NotificationSetting {
  id            String            @id @default(uuid())
  userId        String
  type          NotificationType
  emailEnabled  Boolean           @default(true)
  inAppEnabled  Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  user          User              @relation("UserNotificationSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type], map: "uniq_notification_setting_user_type")
  @@index([userId], map: "idx_notification_setting_user")
}

model Notification {
  id        String            @id @default(uuid())
  userId    String
  type      NotificationType
  payload   Json
  readAt    DateTime?
  createdAt DateTime          @default(now())
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Review {
  id             String        @id @default(uuid())
  orderId        String
  authorId       String
  targetUserId   String
  rating         Int
  body           String
  status         ReviewStatus  @default(PENDING)
  moderationNotes String?
  submittedAt    DateTime      @default(now())
  moderatedAt    DateTime?
  order          Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  author         User          @relation("AuthorReviews", fields: [authorId], references: [id], onDelete: Cascade)
  targetUser     User          @relation("TargetReviews", fields: [targetUserId], references: [id], onDelete: Cascade)
  decisions      ReviewModerationDecision[]

  @@unique([orderId, authorId], map: "uniq_review_order_author")
  @@index([targetUserId], map: "idx_review_target_user")
}

model ReviewModerationDecision {
  id          String       @id @default(uuid())
  reviewId    String
  moderatorId String?
  status      ReviewStatus
  reason      String?
  createdAt   DateTime     @default(now())
  review      Review       @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  moderator   User?        @relation("UserReviewModerations", fields: [moderatorId], references: [id])

  @@index([reviewId], map: "idx_review_decision_review")
}

model ModerationEvent {
  id        String               @id @default(uuid())
  type      ModerationEventType
  entityId  String
  actorId   String?
  action    String
  metadata  Json?
  createdAt DateTime             @default(now())
  actor     User?                @relation(fields: [actorId], references: [id])

  @@index([type], map: "idx_moderation_event_type")
  @@index([entityId], map: "idx_moderation_event_entity")
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String?
  entity    String
  entityId  String
  action    String
  metadata  Json?
  createdAt DateTime @default(now())
  actor     User?    @relation("UserAuditLogs", fields: [actorId], references: [id])
}
